<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Command | Team Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              executive: {
                950: '#050507', // Deepest background
                900: '#0f0f13', // Card background
                800: '#27272a', // Light Borders
                700: '#3f3f46', // Hover states
                gold: '#FFC300',
                goldDim: '#B38F00',
              }
            }
          }
        }
      }
    </script>

    <style>
      body {
        background-color: #050507;
        color: #e4e4e7;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #0f0f13; 
      }
      ::-webkit-scrollbar-thumb {
        background: #27272a; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #3f3f46; 
      }
      
      .glass-panel {
        background: rgba(15, 15, 19, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col">

    <nav class="glass-panel sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-2 h-8 bg-executive-gold rounded-full"></div>
                <h1 class="text-xl font-bold tracking-tight text-white">COMMAND <span class="text-gray-500 font-light">CENTER</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="lastUpdate" class="text-xs text-zinc-500 font-mono">Synced: --:--</span>
                <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-executive-900 border border-white/5 rounded-lg text-sm font-medium hover:bg-white/5 transition-all text-zinc-400">
                    <i data-lucide="rotate-cw" class="w-4 h-4" id="refreshIcon"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-7xl mx-auto px-6 py-10 w-full space-y-10">

        <div class="flex flex-col md:flex-row justify-between items-end gap-6 border-b border-white/5 pb-10">
            <div>
                <h2 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight mb-2">Team Performance</h2>
                <p class="text-zinc-400">Real-time operational intelligence and metric tracking.</p>
            </div>
            
            <div class="bg-executive-900 p-1 rounded-lg border border-white/10 flex">
                <button id="trackerToggle" onclick="dashboard.switchDataSource('tracker')" class="px-6 py-2 rounded-md text-sm font-medium transition-all text-zinc-400 hover:text-white">
                    Team Tracker
                </button>
                <button id="freshserviceToggle" onclick="dashboard.switchDataSource('freshservice')" class="px-6 py-2 rounded-md text-sm font-medium transition-all text-zinc-400 hover:text-white">
                    Freshservice
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Timeframe</label>
                <div class="flex flex-col gap-2">
                    <input type="date" id="startDate" class="bg-executive-900 border border-white/10 rounded-lg px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-executive-gold focus:ring-1 focus:ring-executive-gold transition-colors">
                    <input type="date" id="endDate" class="bg-executive-900 border border-white/10 rounded-lg px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-executive-gold focus:ring-1 focus:ring-executive-gold transition-colors">
                    <div class="flex justify-between mt-2">
                        <button onclick="dashboard.clearAllFilters()" class="text-xs text-zinc-500 hover:text-white underline decoration-dotted">Clear Filters</button>
                        <button id="exportBtn" class="text-xs text-executive-gold hover:text-executive-goldDim font-medium flex items-center gap-1">
                            <i data-lucide="download" class="w-3 h-3"></i> CSV
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label id="engineerFilterLabel" class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Personnel</label>
                        <span class="text-[10px] text-zinc-600 bg-executive-900 px-2 py-0.5 rounded border border-white/5">Multi-select</span>
                    </div>
                    <div id="engineerFilters" class="flex flex-wrap gap-2 min-h-[40px] max-h-32 overflow-y-auto pr-2 custom-scrollbar">
                        <span class="text-zinc-600 text-sm italic py-2">Loading personnel...</span>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2 block">Status</label>
                    <div id="statusFilters" class="flex flex-wrap gap-2">
                        </div>
                </div>
            </div>
        </div>

        <div id="statsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <div class="bg-executive-900 border border-white/5 rounded-xl p-6 shadow-lg lg:col-span-1 flex flex-col">
                <h3 class="text-lg font-bold text-white mb-6">Performance Distribution</h3>
                <div class="relative h-64 w-full">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="mt-4 text-xs text-zinc-500 text-center">
                    Resolution rate by personnel
                </div>
            </div>

            <div class="lg:col-span-2">
                <div id="engineerCards" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    </div>
            </div>
        </div>

        <div class="space-y-6">
             <div class="flex justify-between items-center">
                <h3 id="tableTitle" class="text-xl font-bold text-white border-l-4 border-indigo-500 pl-4">Activity Log</h3>
                <div class="text-sm text-zinc-500" id="recordCount"></div>
            </div>
            
            <div class="bg-executive-900 border border-white/5 rounded-xl overflow-hidden shadow-2xl">
                <div class="overflow-x-auto">
                    <div id="tableContent">
                        </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="border-t border-white/5 mt-auto py-8">
        <div class="max-w-7xl mx-auto px-6 text-center text-zinc-600 text-sm">
            <p>&copy; 2024 IT Operations Dashboard. Internal Use Only.</p>
        </div>
    </footer>

    <script>
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbz1jIz73VKcat6GmkqovmqtXHyago4bimxxeaVWekniYU_lowq-e4t9FV1r2PSUqziIKw/exec', 
            API_KEY: '98415623-a1d1-4045-84d3-c3e67fa687af',
            REFRESH_INTERVAL: 300000,
            ENABLE_DEMO: false, 
            ORG_NAME: 'Your Organization'
        };

        // --- Demo Data ---
        const DEMO_DATA_TRACKER = [
            { 'Task': 'API Integration', 'Sub-Task': 'User Auth', 'Engineer': 'Alice Johnson', 'Status': 'Completed', 'Start Date': '2024-10-01', 'Closure Date': '2024-10-15', 'Blocker/Dependency': '' },
            { 'Task': 'API Integration', 'Sub-Task': 'Payment', 'Engineer': 'Bob Smith', 'Status': 'In Progress', 'Start Date': '2024-10-10', 'Closure Date': '', 'Blocker/Dependency': '' },
            { 'Task': 'Database Migration', 'Sub-Task': 'Schema', 'Engineer': 'Carol Davis', 'Status': 'Completed', 'Start Date': '2024-09-15', 'Closure Date': '2024-09-30', 'Blocker/Dependency': '' },
            { 'Task': 'Database Migration', 'Sub-Task': 'Data Transfer', 'Engineer': 'David Lee', 'Status': 'Blocked', 'Start Date': '2024-10-01', 'Closure Date': '', 'Blocker/Dependency': 'Waiting for approval' },
            { 'Task': 'Frontend Redesign', 'Sub-Task': 'Homepage', 'Engineer': 'Emma Wilson', 'Status': 'Completed', 'Start Date': '2024-11-01', 'Closure Date': '2024-11-10', 'Blocker/Dependency': '' },
            { 'Task': 'Frontend Redesign', 'Sub-Task': 'Dashboard', 'Engineer': 'Frank Brown', 'Status': 'In Progress', 'Start Date': '2024-11-05', 'Closure Date': '', 'Blocker/Dependency': '' },
        ];
        
        const DEMO_DATA_FRESHSERVICE = [
            { 'ID': 1001, 'Type': 'Incident', 'Status': 'Resolved', 'Priority': 'High', 'Subject': 'Network outage in building A', 'Agent Name': 'Alice Johnson', 'Created Date': '2024-11-20', 'Resolved Date': '2024-11-20', 'Closed Date': '2024-11-21' },
            { 'ID': 1002, 'Type': 'Service Request', 'Status': 'Open', 'Priority': 'Low', 'Subject': 'Request new laptop for Jane', 'Agent Name': 'Carol Davis', 'Created Date': '2024-11-27', 'Resolved Date': '', 'Closed Date': '' },
            { 'ID': 1003, 'Type': 'Incident', 'Status': 'Pending', 'Priority': 'Medium', 'Subject': 'Printer in HR broken', 'Agent Name': 'Bob Smith', 'Created Date': '2024-11-28', 'Resolved Date': '', 'Closed Date': '' },
            { 'ID': 1004, 'Type': 'Service Request', 'Status': 'Closed', 'Priority': 'High', 'Subject': 'Software installation request', 'Agent Name': 'Alice Johnson', 'Created Date': '2024-11-15', 'Resolved Date': '2024-11-16', 'Closed Date': '2024-11-16' },
            { 'ID': 1005, 'Type': 'Problem', 'Status': 'On Hold', 'Priority': 'Medium', 'Subject': 'Server license issue', 'Agent Name': 'David Lee', 'Created Date': '2024-10-10', 'Resolved Date': '', 'Closed Date': '' },
            { 'ID': 1006, 'Type': 'Incident', 'Status': 'Open', 'Priority': 'High', 'Subject': 'Critical website error', 'Agent Name': 'David Lee', 'Created Date': '2024-11-28', 'Resolved Date': '', 'Closed Date': '' },
        ];

        class Dashboard {
            constructor() {
                this.data = [];
                this.filteredData = [];
                this.metadata = { engineers: [], statuses: [] };
                this.filters = { engineers: [], statuses: [], dateRange: { start: '', end: '' } };
                this.currentSource = 'tracker'; 
                this.chartInstance = null; // Store chart instance to update/destroy
                this.init();
            }

            async init() {
                await this.switchDataSource(this.currentSource, false); 
                this.render();
                setInterval(() => this.loadData(), CONFIG.REFRESH_INTERVAL);
            }

            // Helper for field abstraction
            getFieldValue(item, fieldType) {
                if (!item) return '';
                if (fieldType === 'engineer') {
                    return item['Engineer'] || item['engineer'] || item['Agent Name'] || item['agent_name'] || item['agent'] || item['Responder'] || item['responder_name'] || 'Unassigned';
                }
                if (fieldType === 'date') {
                    return item['Start Date'] || item['start_date'] || item['Created Date'] || item['created_at'] || '';
                }
                return '';
            }

            async switchDataSource(source, reload = true) {
                this.currentSource = source;
                
                // Toggle Styles
                const activeClass = "bg-executive-gold text-executive-950 font-bold shadow-lg";
                const inactiveClass = "text-zinc-400 hover:text-white";

                const trackerBtn = document.getElementById('trackerToggle');
                const fsBtn = document.getElementById('freshserviceToggle');

                trackerBtn.className = "px-6 py-2 rounded-md text-sm transition-all duration-300 " + (source === 'tracker' ? activeClass : inactiveClass);
                fsBtn.className = "px-6 py-2 rounded-md text-sm transition-all duration-300 " + (source === 'freshservice' ? activeClass : inactiveClass);
                
                document.getElementById('tableTitle').textContent = source === 'tracker' ? 'Engineering Tasks' : 'Helpdesk Tickets';
                document.getElementById('engineerFilterLabel').textContent = source === 'tracker' ? 'ENGINEERS' : 'AGENTS';

                if (reload) {
                    this.filters = { engineers: [], statuses: [], dateRange: { start: '', end: '' } };
                    document.getElementById('startDate').value = '';
                    document.getElementById('endDate').value = '';
                    await this.loadData();
                }
            }

            async loadData() {
                const refreshIcon = document.getElementById('refreshIcon');
                if(refreshIcon) refreshIcon.classList.add('animate-spin');

                try {
                    if (CONFIG.ENABLE_DEMO) {
                        await new Promise(r => setTimeout(r, 600)); 
                        this.data = this.currentSource === 'tracker' ? DEMO_DATA_TRACKER : DEMO_DATA_FRESHSERVICE;
                    } else {
                         if (!CONFIG.APPS_SCRIPT_URL || !CONFIG.API_KEY) throw new Error('Missing CONFIG');
                        const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getData&source=${this.currentSource}&key=${CONFIG.API_KEY}`);
                        const result = await response.json();
                        if (!result.success) throw new Error(result.message);
                        this.data = result.data;
                    }

                    // Metadata derivation
                    const distinctEngineers = [...new Set(this.data.map(item => this.getFieldValue(item, 'engineer')))]
                        .filter(name => name && name !== 'Unassigned' && name.trim() !== '').sort();
                    const distinctStatuses = [...new Set(this.data.map(item => item.Status))].filter(Boolean).sort();

                    this.metadata = { engineers: distinctEngineers, statuses: distinctStatuses };

                    this.applyFilters();
                    this.render();
                    document.getElementById('lastUpdate').textContent = 'Synced: ' + new Date().toLocaleTimeString();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error loading data: ' + error.message);
                } finally {
                    if(refreshIcon) refreshIcon.classList.remove('animate-spin');
                }
            }

            applyFilters() {
                let filtered = [...this.data];

                if (this.filters.engineers.length > 0) {
                    filtered = filtered.filter(item => this.filters.engineers.includes(this.getFieldValue(item, 'engineer')));
                }
                if (this.filters.statuses.length > 0) {
                    filtered = filtered.filter(item => this.filters.statuses.includes(item.Status));
                }
                if (this.filters.dateRange.start && this.filters.dateRange.end) {
                    const start = new Date(this.filters.dateRange.start);
                    const end = new Date(this.filters.dateRange.end);
                    filtered = filtered.filter(item => {
                        const dateStr = this.getFieldValue(item, 'date');
                        if (!dateStr) return false;
                        const date = new Date(dateStr);
                        return date >= start && date <= end; 
                    });
                }
                this.filteredData = filtered;
            }

            toggleEngineerFilter(engineer) {
                const idx = this.filters.engineers.indexOf(engineer);
                if (idx > -1) this.filters.engineers.splice(idx, 1);
                else this.filters.engineers.push(engineer);
                this.applyFilters();
                this.render();
            }

            toggleStatusFilter(status) {
                const idx = this.filters.statuses.indexOf(status);
                if (idx > -1) this.filters.statuses.splice(idx, 1);
                else this.filters.statuses.push(status);
                this.applyFilters();
                this.render();
            }

            clearAllFilters() {
                this.filters = { engineers: [], statuses: [], dateRange: { start: '', end: '' } };
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                this.applyFilters();
                this.render();
            }

            getMetrics() {
                const completedStatuses = this.currentSource === 'freshservice' ? ['Resolved', 'Closed'] : ['Completed'];
                const inProgressStatuses = this.currentSource === 'freshservice' ? ['Open', 'Pending', 'On Hold'] : ['In Progress', 'Not Started'];
                const highPriorityOpenStatuses = this.currentSource === 'freshservice' 
                    ? this.filteredData.filter(d => d.Status === 'Open' && d.Priority === 'High') : [];
                
                const completed = this.filteredData.filter(d => completedStatuses.includes(d.Status)).length;
                const inProgress = this.filteredData.filter(d => inProgressStatuses.includes(d.Status)).length;
                const blocked = this.currentSource === 'tracker' 
                    ? this.filteredData.filter(d => d.Status === 'Blocked').length
                    : highPriorityOpenStatuses.length;

                const total = this.filteredData.length;

                return { total, completed, inProgress, blocked };
            }

            getEngineerStats() {
                const stats = {};
                const completedStatuses = this.currentSource === 'freshservice' ? ['Resolved', 'Closed'] : ['Completed'];
                
                this.filteredData.forEach(item => {
                    const name = this.getFieldValue(item, 'engineer');
                    if (!name || name === 'Unassigned') return;
                    if (!stats[name]) stats[name] = { total: 0, completed: 0 };
                    stats[name].total++;
                    if (completedStatuses.includes(item.Status)) stats[name].completed++;
                });

                return Object.entries(stats)
                    .map(([name, data]) => ({
                        name,
                        ...data,
                        rate: data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0
                    }))
                    .sort((a, b) => b.rate - a.rate);
            }

            render() {
                this.renderFilters();
                this.renderStats();
                this.renderEngineerSection(); // Renders Chart + Cards
                this.renderTable();
                
                if (window.lucide) {
                    window.lucide.createIcons();
                }
                
                document.getElementById('recordCount').innerText = `${this.filteredData.length} records found`;
            }

            renderFilters() {
                const engContainer = document.getElementById('engineerFilters');
                const statContainer = document.getElementById('statusFilters');
                if(!engContainer || !statContainer) return;

                const engineerList = this.metadata.engineers || [];
                
                if (engineerList.length === 0) {
                    engContainer.innerHTML = '<span class="text-zinc-600 text-xs italic">No agents found</span>';
                } else {
                    const engineerHTML = engineerList.map(eng => {
                        const isActive = this.filters.engineers.includes(eng);
                        return `
                            <button class="px-3 py-1 text-xs font-medium rounded-full border transition-all duration-200 ${isActive ? 'bg-executive-gold text-executive-950 border-executive-gold' : 'bg-executive-900 text-zinc-400 border-white/5 hover:border-white/20 hover:text-white'}" onclick="dashboard.toggleEngineerFilter('${eng}')">
                                ${eng}
                            </button>
                        `;
                    }).join('');
                    engContainer.innerHTML = engineerHTML;
                }

                const statusHTML = (this.metadata.statuses || []).map(status => {
                    const isActive = this.filters.statuses.includes(status);
                    return `
                        <button class="px-3 py-1 text-xs font-medium rounded-full border transition-all duration-200 ${isActive ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-executive-900 text-zinc-400 border-white/5 hover:border-white/20 hover:text-white'}" onclick="dashboard.toggleStatusFilter('${status}')">
                            ${status}
                        </button>
                    `;
                }).join('');
                statContainer.innerHTML = statusHTML;
            }

            // Styled matching the React StatCard
            renderStats() {
                const metrics = this.getMetrics();
                const completedLabel = this.currentSource === 'tracker' ? 'Completed' : 'Resolved';
                const inProgressLabel = this.currentSource === 'tracker' ? 'In Progress' : 'Open/Pending';
                const blockedLabel = this.currentSource === 'tracker' ? 'Blocked' : 'High Priority Open';

                // Helpers for color mapping
                const createCard = (label, value, iconName, colorText, bgSub) => `
                    <div class="bg-executive-900 border border-white/5 rounded-xl p-6 shadow-lg hover:border-white/10 transition-all duration-300 group">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-zinc-500 text-xs font-semibold uppercase tracking-wider mb-1">${label}</p>
                                <h3 class="text-3xl font-bold ${colorText}">${value}</h3>
                            </div>
                            <div class="p-3 rounded-lg bg-white/5 ${bgSub} group-hover:bg-white/10 transition-colors">
                                <i data-lucide="${iconName}" class="w-6 h-6"></i>
                            </div>
                        </div>
                    </div>
                `;

                const html = `
                    ${createCard('Total Items', metrics.total, 'trending-up', 'text-white', 'text-zinc-400')}
                    ${createCard(completedLabel, metrics.completed, 'check-circle', 'text-emerald-400', 'text-emerald-400/80')}
                    ${createCard(inProgressLabel, metrics.inProgress, 'clock', 'text-indigo-400', 'text-indigo-400/80')}
                    ${createCard(blockedLabel, metrics.blocked, 'alert-circle', 'text-red-400', 'text-red-400/80')}
                `;
                document.getElementById('statsGrid').innerHTML = html;
            }

            renderEngineerSection() {
                const engineers = this.getEngineerStats();
                const cardSubtitleText = this.currentSource === 'tracker' ? 'Items' : 'Items';

                // 1. Render Cards (Right Side)
                const cardsHTML = engineers.map(eng => `
                    <div class="bg-executive-900 border border-white/5 rounded-xl p-5 hover:border-executive-gold/30 transition-all duration-200 group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-executive-gold to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-gray-200 text-lg">${eng.name}</h4>
                                <p class="text-zinc-500 text-sm">${eng.completed} / ${eng.total} ${cardSubtitleText}</p>
                            </div>
                            <div class="text-2xl font-black text-executive-gold">${eng.rate}%</div>
                        </div>
                        
                        <div class="w-full bg-zinc-800 rounded-full h-2 overflow-hidden">
                            <div 
                                class="h-full bg-gradient-to-r from-indigo-500 to-executive-gold transition-all duration-500" 
                                style="width: ${eng.rate}%"
                            ></div>
                        </div>
                    </div>
                `).join('');

                const container = document.getElementById('engineerCards');
                if (container) {
                    container.innerHTML = cardsHTML || '<div class="col-span-2 text-center text-zinc-500 py-10 italic">No performance data available.</div>';
                }

                // 2. Render Chart (Left Side)
                this.updateChart(engineers);
            }

            updateChart(engineers) {
                const canvas = document.getElementById('performanceChart');
                if (!canvas) return;

                const topEngineers = engineers.slice(0, 10); // Limit to top 10 for cleanliness
                const labels = topEngineers.map(e => e.name);
                const dataRates = topEngineers.map(e => e.rate);
                
                // Color logic based on rate
                const colors = dataRates.map(rate => 
                    rate >= 80 ? '#10b981' : // Emerald
                    rate >= 50 ? '#6366f1' : // Indigo
                    '#f59e0b' // Amber
                );

                if (this.chartInstance) {
                    this.chartInstance.destroy();
                }

                this.chartInstance = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Completion Rate %',
                            data: dataRates,
                            backgroundColor: colors,
                            borderRadius: 4,
                            barThickness: 12,
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal bars like the Recharts example
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#18181b',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#27272a',
                                borderWidth: 1,
                                padding: 10,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return context.raw + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: false,
                                max: 100
                            },
                            y: {
                                ticks: {
                                    color: '#a1a1aa', // zinc-400
                                    font: { size: 11 }
                                },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            exportCSV() {
                 let headers, rows;
                const source = this.currentSource;
                if (source === 'freshservice') {
                    headers = ['ID', 'Type', 'Status', 'Priority', 'Subject', 'Agent Name', 'Created Date', 'Resolved Date'];
                    rows = this.filteredData.map(item => [item.ID, item.Type, item.Status, item.Priority, item.Subject, this.getFieldValue(item, 'engineer'), item['Created Date'], item['Resolved Date']]);
                } else { 
                    headers = ['Task', 'Sub-Task', 'Engineer', 'Status', 'Start Date', 'Closure Date', 'Blocker'];
                    rows = this.filteredData.map(item => [
                        item.Task, item['Sub-Task'], this.getFieldValue(item, 'engineer'), item.Status, item['Start Date'], item['Closure Date'], item['Blocker/Dependency']
                    ]);
                }
                const csv = [headers, ...rows].map(row => (row || []).map(cell => `"${cell || ''}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `report_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            }

            renderTable() {
                if (this.filteredData.length === 0) {
                    document.getElementById('tableContent').innerHTML = `
                        <div class="p-12 text-center">
                            <div class="text-4xl mb-4 text-zinc-600">üì≠</div>
                            <h3 class="text-white font-medium mb-1">No Records Found</h3>
                            <p class="text-zinc-500 text-sm">Adjust filters or switch data sources.</p>
                        </div>
                    `;
                    return;
                }

                const getStatusBadge = (status) => {
                    const s = status.toLowerCase();
                    let color = 'bg-zinc-800 text-zinc-300 border-zinc-700';
                    if (['completed', 'resolved', 'closed'].some(x => s.includes(x))) color = 'bg-emerald-900/30 text-emerald-400 border-emerald-900';
                    else if (['in progress', 'open', 'pending'].some(x => s.includes(x))) color = 'bg-indigo-900/30 text-indigo-400 border-indigo-900';
                    else if (['blocked', 'high'].some(x => s.includes(x))) color = 'bg-red-900/30 text-red-400 border-red-900';
                    else if (['on hold'].some(x => s.includes(x))) color = 'bg-amber-900/30 text-amber-400 border-amber-900';
                    
                    return `<span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border ${color}">${status}</span>`;
                };

                let tableHeader, tableRows;
                
                if (this.currentSource === 'freshservice') {
                    tableHeader = `
                        <th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Reference</th>
                        <th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Agent</th>
                        <th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Created</th>
                    `;
                    tableRows = this.filteredData.map(item => `
                        <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                            <td class="px-6 py-4">
                                <div class="text-sm font-bold text-white">#${item.ID || '?'}</div>
                                <div class="text-xs text-zinc-500 truncate max-w-xs">${item.Subject || 'No Subject'}</div>
                            </td>
                            <td class="px-6 py-4 text-sm text-zinc-300">${this.getFieldValue(item, 'engineer')}</td>
                            <td class="px-6 py-4">${getStatusBadge(item.Status)}</td>
                            <td class="px-6 py-4 text-xs text-zinc-500 font-mono">${item['Created Date'] || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tableHeader = `
                        <th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Task</th>
                        <th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Engineer</th>
                        <th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Timeline</th>
                    `;
                    tableRows = this.filteredData.map(item => `
                        <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                            <td class="px-6 py-4">
                                <div class="text-sm font-bold text-white">${item.Task}</div>
                                <div class="text-xs text-zinc-500">${item['Sub-Task'] || ''}</div>
                                ${item['Blocker/Dependency'] ? `<div class="mt-1 text-[10px] text-red-400">‚ö†Ô∏è ${item['Blocker/Dependency']}</div>` : ''}
                            </td>
                            <td class="px-6 py-4 text-sm text-zinc-300">${this.getFieldValue(item, 'engineer')}</td>
                            <td class="px-6 py-4">${getStatusBadge(item.Status)}</td>
                            <td class="px-6 py-4 text-xs text-zinc-500 font-mono">
                                <div>Start: ${item['Start Date']}</div>
                                ${item['Closure Date'] ? `<div>End: ${item['Closure Date']}</div>` : ''}
                            </td>
                        </tr>
                    `).join('');
                }

                document.getElementById('tableContent').innerHTML = `
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-executive-950 border-b border-white/10">
                            <tr>${tableHeader}</tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            ${tableRows}
                        </tbody>
                    </table>
                `;
            }
        }

        let dashboard;
        window.addEventListener('DOMContentLoaded', () => {
            dashboard = new Dashboard();
            
            // Event Listeners for Filters
            document.getElementById('refreshBtn').addEventListener('click', () => dashboard.loadData());
            document.getElementById('exportBtn').addEventListener('click', () => dashboard.exportCSV());
            
            const handleDateChange = () => {
                dashboard.filters.dateRange.start = document.getElementById('startDate').value;
                dashboard.filters.dateRange.end = document.getElementById('endDate').value;
                dashboard.applyFilters();
                dashboard.render();
            };
            
            document.getElementById('startDate').addEventListener('change', handleDateChange);
            document.getElementById('endDate').addEventListener('change', handleDateChange);
        });
    </script>
</body>
</html>
